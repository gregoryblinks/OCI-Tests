-- User for the pipeline
CREATE USER CLOUDGUARD_APP IDENTIFIED BY "CGADW_test0987//";
GRANT CONNECT, RESOURCE TO CLOUDGUARD_APP;
ALTER USER CLOUDGUARD_APP QUOTA UNLIMITED ON DATA;

-- Findings table (flat + raw JSON)
CREATE TABLE CLOUDGUARD_APP.CLOUDGUARD_FINDINGS (
  EVENT_TIME          TIMESTAMP,
  EVENT_TYPE          VARCHAR2(100),
  CLOUD_EVENTS_VERSION VARCHAR2(20),
  PAYLOAD_VERSION     VARCHAR2(20),
  SOURCE              VARCHAR2(100),
  EVENT_ID            VARCHAR2(200),
  TENANT_ID           VARCHAR2(200),
  COMPARTMENT_ID      VARCHAR2(200),
  EXTENSIONS_COMPARTMENT_ID VARCHAR2(200),
  COMPARTMENT_NAME    VARCHAR2(200),
  REGION              VARCHAR2(50),
  PROBLEM_ID          VARCHAR2(200),
  PROBLEM_NAME        VARCHAR2(200),
  PROBLEM_DISPLAY_NAME VARCHAR2(200),
  PROBLEM_TYPE        VARCHAR2(100),
  REASON              VARCHAR2(200),
  SEVERITY            VARCHAR2(20),
  SEVERITY_RANK       NUMBER,
  RISK_LEVEL          VARCHAR2(20),
  RESOURCE_TYPE       VARCHAR2(50),
  RESOURCE_NAME       VARCHAR2(200),
  RESOURCE_ID         VARCHAR2(200),
  TARGET_ID           VARCHAR2(200),
  LIFECYCLE_STATE     VARCHAR2(30),
  PROBLEM_DESCRIPTION CLOB,
  RECOMMENDATION      CLOB,
  FIRST_DETECTED      TIMESTAMP,
  LAST_DETECTED       TIMESTAMP,
  LABELS              VARCHAR2(4000),
  ADDITIONAL_DETAILS_JSON CLOB,
  RAW_EVENT_JSON      CLOB,
  INSERTED_AT         TIMESTAMP DEFAULT SYSTIMESTAMP,
  CONSTRAINT CG_FINDINGS_PK PRIMARY KEY (EVENT_ID)
);

CREATE INDEX CG_IDX_EVTIME ON CLOUDGUARD_APP.CLOUDGUARD_FINDINGS(EVENT_TIME);
CREATE INDEX CG_IDX_SEV    ON CLOUDGUARD_APP.CLOUDGUARD_FINDINGS(SEVERITY_RANK);
CREATE INDEX CG_IDX_COMP   ON CLOUDGUARD_APP.CLOUDGUARD_FINDINGS(COMPARTMENT_NAME);
